var rides = require('config/ridemodel');
var user = require('config/models');
var gcm = require('node-gcm');
exports.addrequest = function(email,name,id,callback) {
 
// var gcm = require('../lib/node-gcm');
var admin_email,admin_GCM_ID ;// to store the email of the user who has shared this ride
var date,startime,origin,end;
var message = new gcm.Message();
rides.find({ride_ID:ride_ID},function(err,rides){
	var len = rides.length;
            // console.log(len);
            if(len == 0){
                console.log('NA');
            }   
            else{
		rides[0].pending_request[len] = email;   
		admin_email = rides[0].adminemail;   
		date = rides[0].date;
		startime = rides[0].startime;
		origin = rides[0].origin;
		end = rides[0].end;
	}
        });
user.find({email:admin_email},function(err,users){
	var len = users.length;
            // console.log(len);
            if(len == 0){
                console.log('NA');
            }   
            else{
        var len = (users[0].recievedrequest).length;
		users[0].recievedrequest[len] = token;
		admin_GCM_ID = users[0].admin_GCM_ID;   
	}
        });

message.addData('message', ''+name+' has requested to travel with you on - '+date+' , from '+origin+' to '+end+' . Tab to Call and confirm ');
// message.addNotification('title', 'Hello');
// message.addNotification('icon', 'ic_launcher');
// message.addNotification('body', 'World');
// {
//     "to": "/topics/foo-bar",
//     "data": {
//       "message": "This is a GCM Topic Message!",
//      }
//   }

//Replace your mobile device registration Id here
// var regIds = ['APA91bHk3MP8ekrhhKDpve266ji9eETRyWlPiDcJ53SK0t2CE5OYoO52ZqCTIXYVvhWlXr3KGx-0BzNc2jPKgIplCbwLKrj9raLFHHv6s4-IR9Rf9QU2ugWCqUG68aDK5hGlUZ83ILk7'];
var regIds = [admin_GCM_ID];
//Replace your developer API key with GCM enabled here
var sender = new gcm.Sender('AIzaSyC_0lcCf28lgrOxtXoJTIVPEA4ivgXxTFw');

sender.send(message, regIds, function (err, result) {
    if(err) {
      console.error(err);
    } else {
      console.log(result);
    }
});
	    callback({'res':true,'response':"Request Sent"});

	// user.find({_id:ID},function(err,users){
	// 	var len = users.length;
	// 	var i = 0;
	// 	while(len == 1 && users[0].recievedrequest[i]=="null"){
	// 	users[0].recievedrequest[i] = token;
	//     callback({'res':true,'response':"Request Sent"});
	//     i++;
	// 	}
	// });
}